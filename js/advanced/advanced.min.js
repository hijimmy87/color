onOpenCvReady=()=>{$('#loadingOpenCV').remove();};$(()=>{$('form').submit(()=>{try{$('#submit').text('處理中...').removeClass('btn-primary').addClass('btn-secondary').attr('disabled', true);setTimeout(a, 100);}catch(error){alert(`Some Error happened. Please try again.\n\n ${error}`);}});});let a=()=>{let a=$('<img class="w-100">')[0],b=$('#img')[0].files[0];a.src=URL.createObjectURL(b);a.onload=function(){let c=new Date(),d,e=$('<canvas class="w-100">')[0],f,g=$('#imgSpace').val(),h=$('#space').val(),i=[],j=Object.keys(Color.space(h).coords),k=$('#email').val(),l=$('main'),m=$('<div class="row mb-3">');console.log(c);if($('#ratio').prop('checked')){if(b=parseInt($('#width').val())){let c=b/a.width;a.width=b;a.height*=c;}else{let b=(parseInt($('#height').val())||a.height)/a.height;a.width*=b;a.height*=b;}}else{a.width||=parseInt($('#width').val());a.height||=parseInt($('#height').val())||a.height;}f=cv.imread(a);if($('#GrayScale').prop('checked')){cv.cvtColor(f,f,cv.COLOR_RGB2GRAY,0);}cv.imshow(e,f);f.delete();f=e.getContext('2d').getImageData(0,0,e.width,e.height).data;for(let a=0;a<f.length;a+=4){let c=new Color(g,Array.from(f.slice(a,a+3)).map(x=>Math.round(x/51*20)/100)).to(h).coords.map(x=>Math.round(x*100)/100);for (let b=0;b<c.length;b++){c[b]||=0;if(!a)i.push([c[b]]);else i[b].push(c[b]);}}f=$('#outlier').val();l.html('<h3>預覽</h3>');l.append(m);l.append('<button class="btn btn-primary mb-5" type="button" onclick="location.reload()">重新提交</button>');l.append('<h3>詳細數據</h3>');for(let a=0;a<j.length;a++)l.append(n(j[a],i[a],f));d=new Date();console.log(d);d=new Date(d-c);d=`${d.getUTCHours()} 時 ${d.getUTCMinutes()} 分 ${d.getUTCSeconds()}.${d.getUTCMilliseconds()} 秒`;m.append($('<div class="col col-12 col-md-4"></div>').append(e));m.append(`<div class="col col-12 col-md-8"><table class="table table-hover"><thead><tr><th scope="col">基本資訊</th><th scope="col">數值</th></tr></thead><tbody><tr><th scope="row">圖片名稱</th><td>${b.name}</td></tr><tr><th scope="row">解析度</th><td>${e.width}x${e.height}</td></tr><tr><th scope="row">資料數</th><td>${e.width*e.height}</td></tr><tr><th scope="row">圖片色域</th><td>${Color.space(g).name}</td></tr><tr><th scope="row">分析使用</th><td>${Color.space(h).name}</td></tr><tr><th scope="row">耗時</th><td>${d}</td></tr></tbody></table></div>`);if(k)alert(`你剛剛輸入了電子郵件信箱\n${k}\n\n\n\n貼心提醒\n請不要在來路不明的網站中輸入個人資訊，如電子郵件\nHiJimmy 關心您`);}},B=(a,b)=>{let c=a.length;if(c==0)return a[0];let n;if(b==0)return a[0];if(b==4)return a[c-1];if((n=c*0.25*b)%1==0)return (a[n-1]+a[n])/2;return a[Math.floor(n)];},n=(a,b,c)=>{c||=0;const d = $('<div class="row mb-3">');let e={},f=0,g=[],h,i=['最小值','第一四分位數','中位數','第三四分位數','最大值'];b.sort((a,b)=>a-b);b=b.slice(b.length*c/200,b.length*(1-c/200));for(let a of b){if(e[a])e[a].y++;else e[a]={x:a,y:1};if(e[a].y>f){f=e[a].y;g=[a];}else if(e[a].y==f){g.push(a);}}f=$(`<table class="table table-hover"><thead><tr><th scope="col">${a}</th><th scope="col">數值</th></tr></thead><tbody></tbody></table>`);h=f.find('tbody');for(let c=0;c<5;c++) {let a=B(b, c);h.append(`<tr><th scope="row">${i[c]}</th><td>${a}</td></tr>`);}g.forEach(a=>h.append(`<tr><th scope="row">眾數</th><td>${a}</td></tr>`));i=b.length;g=Math.round(b.reduce((a,b)=>a+=b)/i*100)/100,i=Math.round(Math.sqrt(b.reduce((a,b)=>a+=Math.pow(b-g,2))/i*100))/100;h.append(`<tr><th scope="row">平均值</th><td>${g}</td></tr><tr><th scope="row">標準差</th><td>${i}</td></tr>`);d.append($('<div class="col col-12 col-sm-6 col-md-4"></div>').html(f));f=$('<div class="col col-12 col-sm-6 col-md-8"><canvas></canvas></div>');g=f.children()[0];d.append(f);g.width=f.width();g.height=f.height();new Chart(g,{type:'scatter',data:{datasets:[{label:'樣本',backgroundColor:'rgb(255,99,132)',borderColor:'rgb(255,99,132)',data:Object.values(e)}]},options:{scales:{x:{title:{display:true,text:a}},y:{title:{display:true,text:'數量'}}}}});return d;};